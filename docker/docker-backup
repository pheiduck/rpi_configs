#!/usr/bin/env sh

# Farben für die Ausgabe
YELLOW='\033[1;33m'
NC='\033[0m'

# Backup-Konfiguration
export ZSTD_CLEVEL=22
export ZSTD_NBTHREADS=2
backupDate=$(date '+%d%m%y')

# Docker-Container stoppen
for dir in docker/*
do
    pushd ${dir}
    docker-compose down
    popd
done

sleep 15

# Backup erstellen
pushd /path/to/userhome
sudo tar --create --sparse --zstd --file docker-backup-$backupDate.tar.zst --checkpoint=.100 docker
popd

sleep 15

# Docker-Container wieder starten
for dir in docker/*
do
    pushd ${dir}
    docker-compose up -d
    popd
done

# Nur die drei neuesten Backups behalten
backup_dir="/path/to/userhome"
backup_pattern="docker-backup-*.tar.zst"
backup_count=$(ls ${backup_dir}/${backup_pattern} 2>/dev/null | wc -l)
if [ $backup_count -gt 3 ]; then
    files_to_delete=$(ls -t ${backup_dir}/${backup_pattern} | tail -n +4)
    for file in $files_to_delete; do
        rm "$file"
        printf "${YELLOW}Lösche altes Backup: %s${NC}\n" "$file"
    done
fi

printf "${YELLOW}Backup abgeschlossen.${NC}\n"
